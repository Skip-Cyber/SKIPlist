<div id="skiplist-oracle" style="max-width:900px;margin:18px auto;padding:14px;border:1px solid #ddd;border-radius:12px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#fff;">
  <h2 style="margin:0 0 10px 0;">üé¥ Tirage SKIPlist (complet)</h2>

  <div style="padding:10px 12px;border:1px solid #eee;border-radius:10px;background:#fafafa;line-height:1.4;margin-bottom:12px;">
    <div style="font-weight:700;margin-bottom:6px;">√Ä propos de ce tirage</div>
    <div>
      Ce tirage en ligne ne remplace pas le geste. Il ne demande ni de m√©langer, ni de toucher, ni de sentir les cartes.<br>
      Il ne fait qu‚Äôouvrir un miroir, √† l‚Äôinstant pr√©cis o√π tu choisis de l‚Äôactiver.<br><br>
      Le sens ne vient pas de l‚Äô√©cran, mais de ce que tu portes d√©j√†. Si tu cherches le poids, le temps et la mati√®re, prends le jeu entre tes mains.
    </div>
    <div style="margin-top:10px;">
      <span style="font-weight:700;">Avant de tirer :</span> fais une pause ¬∑ pose une main sur ton corps ¬∑ respire une fois ¬∑ puis clique.
    </div>
  </div>

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
    <button id="btnDraw"  style="padding:10px 14px;cursor:pointer;">Input1 ‚Äî Tirer une carte</button>
    <button id="btnSkip"  style="padding:10px 14px;cursor:pointer;display:none;">Input2 ‚Äî Activer SKIP</button>
    <button id="btnReset" style="padding:10px 14px;cursor:pointer;">R√©initialiser</button>
  </div>

  <div id="status" style="margin:10px 0;color:#333;line-height:1.35;"></div>

  <div id="cardsArea" style="display:grid;gap:14px;"></div>

  <details style="margin-top:14px;">
    <summary style="cursor:pointer;">Historique</summary>
    <ol id="history" style="margin-top:10px;"></ol>
  </details>
</div>

<script>
(function(){
  "use strict";

  /* =========================
     OUTILS
     ========================= */
  function randIndex(n){ return Math.floor(Math.random() * n); }
  function pick(list){ return list[randIndex(list.length)]; }
  function safeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }
  function uid(){ return "p" + Math.random().toString(16).slice(2); }

  /* =========================
     UI
     ========================= */
  const elStatus  = document.getElementById("status");
  const elArea    = document.getElementById("cardsArea");
  const elHistory = document.getElementById("history");
  const btnDraw   = document.getElementById("btnDraw");
  const btnSkip   = document.getElementById("btnSkip");
  const btnReset  = document.getElementById("btnReset");

  function setStatus(html){ elStatus.innerHTML = html; }

  function addToHistory(label, url){
    const li = document.createElement("li");
    if (url){
      li.innerHTML = `${safeHtml(label)} ‚Äî <a href="${url}" target="_blank" rel="noopener">ouvrir</a>`;
    } else {
      li.textContent = label;
    }
    elHistory.appendChild(li);
  }

  function renderCardBlock(title, url){
    const wrapper = document.createElement("div");
    wrapper.style.border = "1px solid #eee";
    wrapper.style.borderRadius = "12px";
    wrapper.style.padding = "12px";
    wrapper.style.background = "#fafafa";

    const pid = uid();
    const hasUrl = !!url;

    wrapper.innerHTML = `
      <div style="display:flex;gap:10px;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;">
        <div>
          <div style="font-weight:800;margin-bottom:6px;">${safeHtml(title)}</div>
          ${hasUrl ? `<a href="${url}" target="_blank" rel="noopener">Ouvrir la note</a>` : `<span style="color:#666;">(carte interne)</span>`}
        </div>
        ${hasUrl ? `<button data-toggle="${pid}" style="padding:8px 10px;cursor:pointer;">Afficher / masquer l‚Äôaper√ßu</button>` : ``}
      </div>
      ${hasUrl ? `
        <div id="${pid}" style="display:none;margin-top:10px;">
          <iframe src="${url}" style="width:100%;height:520px;border:1px solid #ddd;border-radius:10px;background:#fff;"></iframe>
          <div style="font-size:12px;color:#666;margin-top:6px;">
            Si l‚Äôaper√ßu est bloqu√© (iframe), utilise juste ‚ÄúOuvrir la note‚Äù.
          </div>
        </div>
      ` : ``}
    `;

    const toggleBtn = wrapper.querySelector("button[data-toggle]");
    if (toggleBtn){
      toggleBtn.addEventListener("click", () => {
        const panel = wrapper.querySelector("#" + pid);
        panel.style.display = (panel.style.display === "none") ? "block" : "none";
      });
    }

    elArea.appendChild(wrapper);
  }

  function renderChoiceBlock(title, choices){
    // choices: [{label, cardObj}]
    const wrapper = document.createElement("div");
    wrapper.style.border = "1px solid #eee";
    wrapper.style.borderRadius = "12px";
    wrapper.style.padding = "12px";
    wrapper.style.background = "#fff";

    wrapper.innerHTML = `
      <div style="font-weight:800;margin-bottom:10px;">${safeHtml(title)}</div>
      <div style="display:grid;gap:10px;">
        ${choices.map((c,i)=>`
          <div style="border:1px solid #eee;border-radius:10px;padding:10px;background:#fafafa;display:flex;gap:10px;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;">
            <div>
              <div style="font-weight:700;margin-bottom:6px;">${safeHtml(c.label)}</div>
              ${c.card.url ? `<a href="${c.card.url}" target="_blank" rel="noopener">Ouvrir la note</a>` : `<span style="color:#666;">(carte interne)</span>`}
            </div>
            <button data-pick="${i}" style="padding:8px 10px;cursor:pointer;">Choisir cette carte</button>
          </div>
        `).join("")}
      </div>
    `;

    choices.forEach((c,i)=>{
      wrapper.querySelector(`button[data-pick="${i}"]`).addEventListener("click", ()=>{
        onLibreArbitreChoice(c.card);
        wrapper.remove();
      });
    });

    elArea.appendChild(wrapper);
  }

  /* =========================
     DONN√âES ‚Äî FAMILLES COULEUR (7√ó9 = 63)
     ========================= */
  const familles = {
    violet: [
      "https://artistesrivegauche.hautetfort.com/archive/2025/04/30/en-bon-leader-carte-01-6545763.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/03/02-gare-a-l-ego-6546160.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/03/03-tranquille-6546164.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/03/04-tout-est-okay-6546169.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/03/05-ca-coince-6546185.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/03/06-classs-6546188.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/03/07-prepare-toi-6546193.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/03/08-merci-copain-6546207.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/03/08-malin-malin-6546198.html"
    ],
    bleu: [
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/04/10-ca-roule-6546260.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/04/11-surprise-6546274.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/04/12-ha-ha-ha-6546279.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/04/13-ouf-6546293.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/04/14-oui-mais-6546299.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/04/15-suis-le-guide-6546305.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/04/16-oui-chef-6546307.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/04/17-montre-toi-6546330.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/04/18-a-table-6546342.html"
    ],
    cyan: [ // cyan = indigo
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/05/19-tous-avec-moi-6546422.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/05/20-ca-change-6546448.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/05/21-souple-6546492.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/05/22-etat-de-grace-6546494.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/05/23-courant-chaud-6546507.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/05/24-au-charbon-6546509.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/06/25-periode-faste-6546608.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/06/26-chuuut-6546623.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/06/27-force-pas-6546639.html"
    ],
    vert: [
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/06/28-attention-6546716.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/07/29-transmettre-6546834.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/07/30-la-greve-6546873.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/07/31-6546908.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/07/32-la-patate-6546914.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/08/33-chacun-sa-place-6546991.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/08/34-encore-et-toujours-6547000.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/08/35-rencontre-6547019.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/08/36-avec-des-pincettes-6547023.html"
    ],
    jaune: [
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/10/37-miam-6547284.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/10/38-grrrrr-6547298.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/10/39-chacun-sa-route-6547304.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/11/40-une-eclaircie-6547395.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/11/41-ca-dort-6547421.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/11/42-la-liberation-6547423.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/11/43-montre-l-exemple-6547425.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/11/44-pas-a-pas-6547434.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/11/45-respire-6547438.html"
    ],
    orange: [
      "https://artistesrivegauche.hautetfort.com/archive/2025/05/12/46-cherche-bien-6547502.html",
      "https://artistesrivegauche.hautetfort.com/archive/2025/05/12/47-l-obstacle-6547519.html",
      "https://artistesrivegauche.hautetfort.com/archive/2025/05/12/48-tu-doutes-6547528.html",
      "https://artistesrivegauche.hautetfort.com/archive/2025/05/12/49-pas-d-accord-6547560.html",
      "https://artistesrivegauche.hautetfort.com/archive/2025/05/12/50-la-modestie-6547567.html",
      "https://artistesrivegauche.hautetfort.com/archive/2025/05/12/51-tout-comme-il-faut-6547569.html",
      "https://artistesrivegauche.hautetfort.com/archive/2025/05/13/52-supercherie-6547668.html",
      "https://artistesrivegauche.hautetfort.com/archive/2025/05/13/53-ensemble-6547689.html",
      "https://artistesrivegauche.hautetfort.com/archive/2025/05/13/54-a-l-ecoute-6547701.html"
    ],
    rouge: [
      "https://artistesrivegauche.hautetfort.com/archive/2025/05/14/55-une-ame-de-chef-6547828.html",
      "https://artistesrivegauche.hautetfort.com/archive/2025/05/14/56-le-repli-strategique-6547835.html",
      "https://artistesrivegauche.hautetfort.com/archive/2025/05/14/57-non-6547840.html",
      "https://artistesrivegauche.hautetfort.com/archive/2025/05/14/58-on-se-calme-6547846.html",
      "https://artistesrivegauche.hautetfort.com/archive/2025/05/14/59-pause-6547852.html",
      "https://artistesrivegauche.hautetfort.com/archive/2025/05/16/60-tout-doux-6548082.html",
      "https://artistesrivegauche.hautetfort.com/archive/2025/05/16/61-pas-de-pitie-6548088.html",
      "https://artistesrivegauche.hautetfort.com/archive/2025/05/16/62-yallah-6548094.html",
      "https://artistesrivegauche.hautetfort.com/archive/2025/05/16/63-ca-glisse-6548098.html"
    ]
  };

  /* =========================
     DONN√âES ‚Äî CARTES BLANCHES (24)
     - SUJET (11) dont 7 avec 1 SKIP (skip1)
     - SOIN  (5)
     - VOYAGE (8) (87/88 sont STOP)
     ========================= */
  const blancs = {
    sujet: [
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/16/65-un-homme-6548134.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/18/66-patron-employe-collegue-6548330.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/18/67-ennemi-adversaire-6548337.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/18/68-allie-guide-soignant-6548345.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/18/69-le-binome-couple-ami-e-6548370.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/18/70-le-concurrent-le-jaloux-6548372.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/18/71-le-fournisseur-le-client-6548377.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/18/72-une-femme-6548378.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/18/73-les-voisins-6548385.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/18/74-la-famille-le-clan-6548388.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/18/75-l-etranger-le-voyageur-6548402.html"
    ],
    soin: [
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/18/76-l-energie-du-bois-6548405.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/19/77-energie-du-feu-6548419.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/19/78-energie-de-la-terre-6548442.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/19/79-energie-du-fer-6548458.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/19/80-energie-de-l-eau-6548479.html"
    ],
    voyage: [
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/19/81-le-cosmos-l-ether-6548492.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/19/82-1mn-dans-le-ciel-6548508.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/19/83-1mn-a-ecouter-l-orage-6548561.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/19/84-1mn-pour-ecouter-le-vent-6548567.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/19/85-1mn-pour-te-promener-en-montagne-6548571.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/19/86-1mn-au-bord-d-un-lac-6548573.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/19/87-la-lune-6548584.html",
      "http://artistesrivegauche.hautetfort.com/archive/2025/05/19/88-le-soleil-6548594.html"
    ]
  };

  function poolBlanc(){
    return [].concat(blancs.sujet, blancs.soin, blancs.voyage);
  }

  // Meta ‚Äúblanc SUJET √† 1 SKIP‚Äù
  const whiteSujetMetaByUrl = new Map([
    [blancs.sujet[0], "violet"], // 65
    [blancs.sujet[1], "bleu"],   // 66
    [blancs.sujet[2], "cyan"],   // 67 (cyan = indigo)
    [blancs.sujet[3], "vert"],   // 68
    [blancs.sujet[4], "jaune"],  // 69
    [blancs.sujet[5], "orange"], // 70
    [blancs.sujet[6], "rouge"]   // 71
  ]);

  /* =========================
     DONN√âES ‚Äî DECK COMPLET 1..88
     - 64 = carte interne "Libre arbitre"
     ========================= */
  const deck = [];

  // VIOLET 1-9
  deck.push({id:1,  url:familles.violet[0]});
  deck.push({id:2,  url:familles.violet[1], skip:["bleu","vert"]});                 // corrig√©
  deck.push({id:3,  url:familles.violet[2]});
  deck.push({id:4,  url:familles.violet[3], skip:["rouge","orange"]});
  deck.push({id:5,  url:familles.violet[4], stop:true});
  deck.push({id:6,  url:familles.violet[5], skip:["rouge","jaune"]});
  deck.push({id:7,  url:familles.violet[6]});
  deck.push({id:8,  url:familles.violet[7], skip:["bleu","blanc"]});
  deck.push({id:9,  url:familles.violet[8]});

  // BLEU 10-18
  deck.push({id:10, url:familles.bleu[0]});
  deck.push({id:11, url:familles.bleu[1],  skip:["cyan","violet"]});
  deck.push({id:12, url:familles.bleu[2]});
  deck.push({id:13, url:familles.bleu[3],  skip:["violet","rouge"]});
  deck.push({id:14, url:familles.bleu[4],  stop:true});
  deck.push({id:15, url:familles.bleu[5],  skip:["violet","jaune"]});
  deck.push({id:16, url:familles.bleu[6]});
  deck.push({id:17, url:familles.bleu[7],  skip:["cyan","orange"]});
  deck.push({id:18, url:familles.bleu[8]});

  // CYAN 19-27
  deck.push({id:19, url:familles.cyan[0]});
  deck.push({id:20, url:familles.cyan[1],  skip:["vert","orange"]});
  deck.push({id:21, url:familles.cyan[2]});
  deck.push({id:22, url:familles.cyan[3],  skip:["bleu","violet"]});
  deck.push({id:23, url:familles.cyan[4],  stop:true});
  deck.push({id:24, url:familles.cyan[5],  skip:["bleu","rouge"]});
  deck.push({id:25, url:familles.cyan[6]});
  deck.push({id:26, url:familles.cyan[7],  skip:["jaune","vert"]});                 // corrig√©
  deck.push({id:27, url:familles.cyan[8]});

  // VERT 28-36
  deck.push({id:28, url:familles.vert[0]});
  deck.push({id:29, url:familles.vert[1],  skip:["jaune","rouge"]});
  deck.push({id:30, url:familles.vert[2]});
  deck.push({id:31, url:familles.vert[3],  skip:["cyan","bleu"]});
  deck.push({id:32, url:familles.vert[4],  stop:true});
  deck.push({id:33, url:familles.vert[5],  skip:["cyan","orange"]});
  deck.push({id:34, url:familles.vert[6]});
  deck.push({id:35, url:familles.vert[7],  skip:["jaune","violet"]});
  deck.push({id:36, url:familles.vert[8]});

  // JAUNE 37-45
  deck.push({id:37, url:familles.jaune[0]});
  deck.push({id:38, url:familles.jaune[1], skip:["orange","rouge"]});
  deck.push({id:39, url:familles.jaune[2]});
  deck.push({id:40, url:familles.jaune[3], skip:["vert","blanc"]});
  deck.push({id:41, url:familles.jaune[4], stop:true});
  deck.push({id:42, url:familles.jaune[5], skip:["vert","bleu"]});
  deck.push({id:43, url:familles.jaune[6]});
  deck.push({id:44, url:familles.jaune[7], skip:["orange","vert"]});
  deck.push({id:45, url:familles.jaune[8]});

  // ORANGE 46-54
  deck.push({id:46, url:familles.orange[0]});
  deck.push({id:47, url:familles.orange[1], skip:["rouge","bleu"]});
  deck.push({id:48, url:familles.orange[2]});
  deck.push({id:49, url:familles.orange[3], skip:["jaune","violet"]});
  deck.push({id:50, url:familles.orange[4], stop:true});
  deck.push({id:51, url:familles.orange[5], skip:["jaune","vert"]});
  deck.push({id:52, url:familles.orange[6]});
  deck.push({id:53, url:familles.orange[7], skip:["rouge","jaune"]});
  deck.push({id:54, url:familles.orange[8]});

  // ROUGE 55-63
  deck.push({id:55, url:familles.rouge[0]});
  deck.push({id:56, url:familles.rouge[1], skip:["violet","blanc"]});
  deck.push({id:57, url:familles.rouge[2]});
  deck.push({id:58, url:familles.rouge[3], skip:["orange","cyan"]});                // indigo => cyan
  deck.push({id:59, url:familles.rouge[4], stop:true});
  deck.push({id:60, url:familles.rouge[5], skip:["orange","vert"]});
  deck.push({id:61, url:familles.rouge[6]});
  deck.push({id:62, url:familles.rouge[7], skip:["violet","bleu"]});
  deck.push({id:63, url:familles.rouge[8]});

  // 64 ‚Äî LIBRE ARBITRE (carte interne)
  deck.push({id:64, url:null, special:"libre_arbitre"});

  // 65-75 ‚Äî BLANC SUJET (dont 7 avec skip1)
  deck.push({id:65, url:blancs.sujet[0], skip1:"violet"});
  deck.push({id:66, url:blancs.sujet[1], skip1:"bleu"});
  deck.push({id:67, url:blancs.sujet[2], skip1:"cyan"});
  deck.push({id:68, url:blancs.sujet[3], skip1:"vert"});
  deck.push({id:69, url:blancs.sujet[4], skip1:"jaune"});
  deck.push({id:70, url:blancs.sujet[5], skip1:"orange"});
  deck.push({id:71, url:blancs.sujet[6], skip1:"rouge"});
  deck.push({id:72, url:blancs.sujet[7]});
  deck.push({id:73, url:blancs.sujet[8]});
  deck.push({id:74, url:blancs.sujet[9]});
  deck.push({id:75, url:blancs.sujet[10]});

  // 76-80 ‚Äî BLANC SOIN
  deck.push({id:76, url:blancs.soin[0]});
  deck.push({id:77, url:blancs.soin[1]});
  deck.push({id:78, url:blancs.soin[2]});
  deck.push({id:79, url:blancs.soin[3]});
  deck.push({id:80, url:blancs.soin[4]});

  // 81-88 ‚Äî BLANC VOYAGE (87/88 = STOP)
  deck.push({id:81, url:blancs.voyage[0]});
  deck.push({id:82, url:blancs.voyage[1]});
  deck.push({id:83, url:blancs.voyage[2]});
  deck.push({id:84, url:blancs.voyage[3]});
  deck.push({id:85, url:blancs.voyage[4]});
  deck.push({id:86, url:blancs.voyage[5]});
  deck.push({id:87, url:blancs.voyage[6], stop:true}); // STOP absolu
  deck.push({id:88, url:blancs.voyage[7], stop:true}); // STOP absolu

  // s√©curit√© : carte 87/88 STOP m√™me si modifi√©e ailleurs
  const STOP_IDS = new Set([87,88]);

  /* =========================
     √âTAT
     ========================= */
  let locked = false;

  // carte ‚Äúactive‚Äù pour SKIP
  let currentCard = null;

  // SKIP √©tat
  let waitingForSkip = false;         // SKIP double
  let waitingForSkip1 = false;        // SKIP simple (blanc SUJET)
  let skipTargets = null;             // ["a","b"] ou ["a"] en interne

  // Libre arbitre √©tat
  let waitingLibreArbitre = false;

  function hideSkipButton(){
    btnSkip.style.display = "none";
    waitingForSkip = false;
    waitingForSkip1 = false;
    skipTargets = null;
  }

  function lockStop(reason){
    locked = true;
    hideSkipButton();
    setStatus(`üõë ${reason} ‚Äî fin du tirage. <b>R√©initialise</b> pour recommencer.`);
  }

  function isStopCard(card){
    if (!card) return false;
    if (card.stop) return true;
    if (STOP_IDS.has(card.id)) return true;
    return false;
  }

  /* =========================
     TIRAGES DEPUIS DESTINATIONS
     ========================= */
  function tirerDepuisDestination(dest){
    if (dest === "blanc"){
      const pool = poolBlanc();
      return pick(pool);
    }
    const pack = familles[dest];
    if (!Array.isArray(pack) || pack.length < 1){
      return null;
    }
    return pick(pack);
  }

  function getCardByUrl(url){
    return deck.find(c => c.url === url) || null;
  }

  /* =========================
     AFFICHAGE & LOGIQUE APR√àS TIRAGE
     ========================= */
  function afterCardShown(card, labelPrefix){
    currentCard = card;
    waitingLibreArbitre = false;
    hideSkipButton();

    // STOP ?
    if (isStopCard(card)){
      lockStop(`Carte STOP (#${card.id})`);
      return;
    }

    // Carte 64 ‚Äî Libre arbitre ?
    if (card.special === "libre_arbitre"){
      waitingLibreArbitre = true;
      setStatus(`‚úÖ Carte #64 ‚Äî <b>Libre arbitre</b> : retourne 3 cartes et choisis-en 1. Les deux autres sont ignor√©es.`);
      // bouton sp√©cial via le bouton SKIP (m√™me emplacement, m√™me ergonomie)
      btnSkip.textContent = "Input2 ‚Äî Retourner 3 cartes";
      btnSkip.style.display = "inline-block";
      return;
    }

    // SKIP double ?
    if (Array.isArray(card.skip) && card.skip.length === 2){
      waitingForSkip = true;
      skipTargets = card.skip.slice();
      btnSkip.textContent = "Input2 ‚Äî Activer SKIP";
      btnSkip.style.display = "inline-block";
      setStatus(`‚úÖ Carte consult√©e. Elle porte un SKIP : tirage al√©atoire entre <b>${safeHtml(skipTargets[0])}</b> et <b>${safeHtml(skipTargets[1])}</b>.`);
      return;
    }

    // SKIP simple (blanc SUJET)
    if (typeof card.skip1 === "string" && card.skip1.length){
      waitingForSkip1 = true;
      skipTargets = [card.skip1];
      btnSkip.textContent = "Input2 ‚Äî Activer SKIP";
      btnSkip.style.display = "inline-block";
      setStatus(`‚úÖ Carte BLANC (SUJET) consult√©e. Elle porte un SKIP vers <b>${safeHtml(card.skip1)}</b>.`);
      return;
    }

    setStatus("‚úÖ Carte consult√©e. Tu peux tirer une nouvelle carte (illimit√©).");
  }

  function showCard(card, label){
    const title = `${label} ‚Äî #${card.id}`;
    if (card.special === "libre_arbitre"){
      renderCardBlock(`${title} (Libre arbitre)`, null);
      addToHistory(`${label} #${card.id} (Libre arbitre)`, null);
    } else {
      renderCardBlock(title, card.url);
      addToHistory(`${label} #${card.id}`, card.url);
    }
    afterCardShown(card, label);
  }

  /* =========================
     ACTIONS
     ========================= */
  function tirerInput1(){
    if (locked){
      setStatus("‚õî Tirage verrouill√© (STOP). R√©initialise pour recommencer.");
      return;
    }
    hideSkipButton();

    const card = pick(deck);
    showCard(card, "Input1");
  }

  function doSkipFromTargets(){
    if (!skipTargets || skipTargets.length < 1) return;

    // tirage vers 1 ou 2 destinations
    let dest;
    if (skipTargets.length === 1){
      dest = skipTargets[0];
    } else {
      dest = (Math.random() < 0.5) ? skipTargets[0] : skipTargets[1];
    }

    // destination "blanc" => tirer une URL blanche, puis retrouver la carte correspondante (id 65-88)
    if (dest === "blanc"){
      const url = tirerDepuisDestination("blanc");
      const card = getCardByUrl(url) || {id:"?", url:url};
      // si carte blanche SUJET √† 1 skip, on veut skip1 -> on l‚Äôa d√©j√† dans deck (65-71)
      const realCard = getCardByUrl(url) || card;

      // Afficher
      renderCardBlock(`Input2 (SKIP ‚Üí blanc) ‚Äî #${realCard.id}`, realCard.url || url);
      addToHistory(`Input2 (SKIP ‚Üí blanc) #${realCard.id}`, realCard.url || url);

      // Appliquer la logique d'apr√®s affichage
      afterCardShown(realCard, "Input2");
      return;
    }

    // destination couleur
    const url2 = tirerDepuisDestination(dest);
    if (!url2){
      setStatus(`‚ö†Ô∏è Famille "${safeHtml(dest)}" indisponible.`);
      hideSkipButton();
      return;
    }

    // retrouver carte par URL (pour id/stop/skip1 √©ventuels)
    const card2 = getCardByUrl(url2) || {id:"?", url:url2};

    renderCardBlock(`Input2 (SKIP ‚Üí ${dest}) ‚Äî #${card2.id}`, card2.url);
    addToHistory(`Input2 (SKIP ‚Üí ${dest}) #${card2.id}`, card2.url);
    afterCardShown(card2, "Input2");
  }

  function doLibreArbitre(){
    // retourne 3 cartes "prochaines" (tirages al√©atoires) ‚Äî on √©vite 64 pour ne pas boucler
    const candidates = [];
    let safety = 0;
    while (candidates.length < 3 && safety < 200){
      safety++;
      const c = pick(deck);
      if (c.id === 64) continue;
      // on autorise STOP dans les options (c‚Äôest le jeu)
      // on √©vite doublons exacts
      if (candidates.some(x => x.id === c.id)) continue;
      candidates.push(c);
    }

    renderChoiceBlock(
      "Libre arbitre ‚Äî 3 cartes retourn√©es : choisis-en 1 (les 2 autres sont ignor√©es).",
      candidates.map((c,idx)=>({
        label: `Option ${idx+1} ‚Äî Carte #${c.id}`,
        card: c
      }))
    );

    // apr√®s avoir g√©n√©r√© les choix, on ferme le bouton tant que pas choisi
    hideSkipButton();
    setStatus("‚úÖ Choisis une des 3 cartes propos√©es (tu peux l‚Äôouvrir/consulter avant de valider).");
  }

  function onLibreArbitreChoice(card){
    // la carte choisie devient la carte affich√©e (Input2)
    renderCardBlock(`Input2 (Libre arbitre ‚Äî carte choisie) ‚Äî #${card.id}`, card.url);
    addToHistory(`Input2 (Libre arbitre ‚Äî choix) #${card.id}`, card.url);
    afterCardShown(card, "Input2");
  }

  function onSkipClick(){
    if (locked) return;

    // Libre arbitre (carte 64)
    if (waitingLibreArbitre && currentCard && currentCard.special === "libre_arbitre"){
      doLibreArbitre();
      return;
    }

    // SKIP double ou simple
    if (waitingForSkip || waitingForSkip1){
      doSkipFromTargets();
      return;
    }

    setStatus("‚ÑπÔ∏è Pas de SKIP actif.");
  }

  function resetAll(){
    locked = false;
    currentCard = null;
    waitingLibreArbitre = false;
    hideSkipButton();
    elArea.innerHTML = "";
    elHistory.innerHTML = "";
    btnSkip.textContent = "Input2 ‚Äî Activer SKIP";
    setStatus("R√©initialis√©. Formule ta question int√©rieurement‚Ä¶ puis tire une carte (Input1).");
  }

  /* =========================
     EVENTS
     ========================= */
  btnDraw.addEventListener("click", tirerInput1);
  btnSkip.addEventListener("click", onSkipClick);
  btnReset.addEventListener("click", resetAll);

  // init
  setStatus("Formule ta question int√©rieurement‚Ä¶ puis tire une carte (Input1).");
})();
</script>
